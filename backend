from flask import Flask, render_template, request
import requests
import json

app = Flask(__name__)

# Funzione per fare la richiesta all'API
def aggiungi_sacca():
    url = "http://endpoint-della-tua-api"  # Sostituisci con l'URL corretto
    payload = {
        "cmd": "Addkv",
        "Key": "chiaveIdentificativaSacca",
        "Value": "valoreCasuale"
    }
    headers = {'Content-Type': 'application/json'}
    
    try:
        response = requests.post(url, json=payload, headers=headers)
        # Controllo il codice di stato per evitare errori
        if response.status_code == 200:
            return response.json()  # Restituisce la risposta come JSON
        else:
            return {"error": "Errore nella richiesta API", "status_code": response.status_code}
    except Exception as e:
        return {"error": str(e)}  # Restituisce l'errore nel caso di eccezione

def traccia_sacca():
    url = "http://endpoint-della-tua-api"  # Sostituisci con l'URL corretto
    payload = {
        "cmd": "Addkv",
        "Key": "chiaveIdentificativaSacca",
        "Value": "valoreCasuale"
    }
    headers = {'Content-Type': 'application/json'}
    
    try:
        response = requests.post(url, data=json.dumps(payload), headers=headers)
        # Controllo il codice di stato per evitare errori
        if response.status_code == 200:
            return response.json()  # Restituisce la risposta come JSON
        else:
            return {"error": "Errore nella richiesta API", "status_code": response.status_code}
    except Exception as e:
        return {"error": str(e)}  # Restituisce l'errore nel caso di eccezione

# Funzione per chiamare l'API e aggiungere una sacca con i parametri del form
def aggiungi_sacca_dinamica(campo1, campo2, campo3):
    url = "http://endpoint-della-tua-api"  # Sostituisci con l'URL corretto
    payload = {
        "cmd": "Addkv",
        "Key": campo1,
        "Value": {"campo2": campo2, "campo3": campo3}
    }
    headers = {'Content-Type': 'application/json'}
    
    try:
        response = requests.post(url, json=payload, headers=headers)
        if response.status_code == 200:
            return response.json()
        else:
            return {"error": "Errore nella richiesta API", "status_code": response.status_code}
    except Exception as e:
        return {"error": str(e)}

# Route per la pagina principale (index)
@app.route("/")
def index():
    return render_template("index.html")

# Route per visualizzare il form
@app.route("/aggiungi")
def aggiungi():
    return render_template("aggiungi.html")

# Route per ricevere i dati dal form e chiamare l'API
@app.route("/aggiungi/invia", methods=["POST"])
def invia():
    # Prendi i dati dal form
    campo1 = request.form.get("campo1")
    campo2 = request.form.get("campo2")
    campo3 = request.form.get("campo3")
    
    # Chiama la funzione che interagisce con l'API
    esito_aggiunta = aggiungi_sacca_dinamica(campo1, campo2, campo3)
    
    # Restituisci un template con l'esito
    return render_template("invio.html", esito=esito_aggiunta)

@app.route("/tracciamento")
def traccia():
    esito_tracciamento = traccia_sacca()
    return render_template("tracciamento.html", esito=esito_tracciamento)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=80, debug=True)
